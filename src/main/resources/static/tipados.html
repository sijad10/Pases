<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestión de Tipados - PASES</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Tailwind Play CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { padding-top: 1.2rem; }
    .modal { z-index: 2000; }
  </style>
</head>
<body class="bg-gray-50">
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3">Tipados — Sistema PASES</h1>
    <div>
      <button id="btnRefresh" class="btn btn-outline-secondary me-2">Refrescar</button>
      <button id="btnNuevo" class="btn btn-primary">Nuevo Tipado</button>
    </div>
  </div>

  <div id="alerts"></div>

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <table class="table table-striped mb-0" id="tipadosTable">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Tipo ID</th>
            <th>Nombre</th>
            <th>Cod Rpog</th>
            <th>Activo</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tipadosTbody">
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal Crear/Editar -->
<div class="modal fade" id="tipadoModal" tabindex="-1" aria-labelledby="tipadoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form id="tipadoForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="tipadoModalLabel">Nuevo Tipado</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="tipadoId" />

        <div class="mb-3">
          <label for="tipadoTipoId" class="form-label">Tipo ID (opcional)</label>
          <input id="tipadoTipoId" class="form-control" type="number" />
        </div>

        <div class="mb-3">
          <label for="tipadoNombre" class="form-label">Nombre</label>
          <input id="tipadoNombre" class="form-control" maxlength="200" required />
        </div>

        <div class="mb-3">
          <label for="tipadoCod" class="form-label">Cod Rpog</label>
          <input id="tipadoCod" class="form-control" maxlength="20" required />
        </div>

        <div class="mb-3 form-check">
          <input id="tipadoActivo" type="checkbox" class="form-check-input" />
          <label class="form-check-label" for="tipadoActivo">Activo</label>
        </div>

        <div id="formError" class="text-danger small"></div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary" id="btnGuardar">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const API = '/tipados';
  const tipadoModalEl = document.getElementById('tipadoModal');
  const tipadoModal = new bootstrap.Modal(tipadoModalEl);

  const tipadosTbody = document.getElementById('tipadosTbody');
  const alerts = document.getElementById('alerts');

  const form = document.getElementById('tipadoForm');
  const inputId = document.getElementById('tipadoId');
  const inputTipoId = document.getElementById('tipadoTipoId');
  const inputNombre = document.getElementById('tipadoNombre');
  const inputCod = document.getElementById('tipadoCod');
  const inputActivo = document.getElementById('tipadoActivo');
  const formError = document.getElementById('formError');

  document.getElementById('btnNuevo').addEventListener('click', openCreateForm);
  document.getElementById('btnRefresh').addEventListener('click', loadTipados);

  function showAlert(msg, type='success', timeout=3500) {
    const id = 'a' + Date.now();
    alerts.insertAdjacentHTML('beforeend', `
      <div id="${id}" class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${msg}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>`);
    if (timeout) setTimeout(()=>{ const el=document.getElementById(id); if (el) bootstrap.Alert.getOrCreateInstance(el).close(); }, timeout);
  }
  function showError(msg) { showAlert(msg, 'danger'); }

  // normaliza registro tipado del backend a campos JS
  function normalize(t) {
    if (!t) return null;
    const id = t.id ?? t.ID ?? null;
    const tipoId = t.tipoId ?? t.TIPO_ID ?? t.tipo_id ?? null;
    const nombre = t.nombre ?? t.NOMBRE ?? t.name ?? '';
    const cod = t.codRpog ?? t.COD_RPOG ?? t.cod_rpog ?? '';
    let activo = t.activo ?? t.ACTIVO ?? t.active ?? 0;
    if (activo === 1 || activo === '1') activo = true;
    else if (activo === 0 || activo === '0') activo = false;
    else activo = Boolean(activo);
    return { id, tipoId, nombre, cod, activo };
  }

  async function loadTipados() {
    tipadosTbody.innerHTML = '<tr><td colspan="6" class="text-center py-3">Cargando...</td></tr>';
    try {
      const res = await fetch(API, { headers: { 'Accept': 'application/json' }});
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const payload = await res.json();
      // aceptar array directo o { data: [...] }
      const arr = Array.isArray(payload) ? payload : (payload.data ?? payload.tipados ?? payload.result ?? []);
      const rows = (Array.isArray(arr) ? arr : []).map(normalize);
      renderTable(rows);
    } catch (err) {
      console.error(err);
      tipadosTbody.innerHTML = '<tr><td colspan="6" class="text-danger text-center py-3">No se pudo cargar</td></tr>';
      showError('No se pudo cargar tipados. Revisa backend/CORS.');
    }
  }

  function renderTable(rows) {
    if (!Array.isArray(rows) || rows.length === 0) {
      tipadosTbody.innerHTML = '<tr><td colspan="6" class="text-center py-3">No hay tipados</td></tr>';
      return;
    }
    tipadosTbody.innerHTML = rows.map(r => `
      <tr>
        <td>${escapeHtml(r.id ?? '')}</td>
        <td>${escapeHtml(r.tipoId ?? '')}</td>
        <td>${escapeHtml(r.nombre ?? '')}</td>
        <td>${escapeHtml(r.cod ?? '')}</td>
        <td>${r.activo ? 'Sí' : 'No'}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary me-1" onclick="openEdit(${r.id})">Editar</button>
          <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete(${r.id})">Eliminar</button>
        </td>
      </tr>`).join('');
  }

  async function openEdit(id) {
    try {
      const res = await fetch(`${API}/${id}`, { headers:{ 'Accept':'application/json' }});
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const raw = await res.json();
      const t = Array.isArray(raw) ? raw[0] : raw;
      const n = normalize(t);
      inputId.value = n.id ?? '';
      inputTipoId.value = n.tipoId ?? '';
      inputNombre.value = n.nombre ?? '';
      inputCod.value = n.cod ?? '';
      inputActivo.checked = !!n.activo;
      formError.textContent = '';
      document.getElementById('tipadoModalLabel').textContent = 'Editar Tipado';
      tipadoModal.show();
    } catch (err) {
      console.error(err);
      showError('No se pudo cargar el tipado.');
    }
  }

  function openCreateForm() {
    inputId.value = '';
    inputTipoId.value = '';
    inputNombre.value = '';
    inputCod.value = '';
    inputActivo.checked = true;
    formError.textContent = '';
    document.getElementById('tipadoModalLabel').textContent = 'Nuevo Tipado';
    tipadoModal.show();
  }

  form.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    formError.textContent = '';

    const payload = {
      tipoId: inputTipoId.value ? Number(inputTipoId.value) : null,
      nombre: inputNombre.value.trim(),
      codRpog: inputCod.value.trim(),
      activo: inputActivo.checked ? 1 : 0
    };

    if (!payload.nombre || !payload.codRpog) {
      formError.textContent = 'Completa nombre y código.';
      return;
    }

    try {
      if (inputId.value) {
        const id = inputId.value;
        const res = await fetch(`${API}/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) { const txt = await res.text(); throw new Error(res.status + ' ' + txt); }
        await res.json();
        showAlert('Tipado actualizado.');
      } else {
        const res = await fetch(API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) { const txt = await res.text(); throw new Error(res.status + ' ' + txt); }
        await res.json();
        showAlert('Tipado creado.');
      }
      tipadoModal.hide();
      loadTipados();
    } catch (err) {
      console.error(err);
      formError.textContent = 'Error: ' + (err.message || 'Ver consola');
    }
  });

  function confirmDelete(id) {
    if (!confirm(`Eliminar tipado id=${id}?`)) return;
    deleteTipado(id);
  }

  async function deleteTipado(id) {
    try {
      const res = await fetch(`${API}/${id}`, { method: 'DELETE' });
      if (!res.ok) { const txt = await res.text(); throw new Error(res.status + ' ' + txt); }
      showAlert('Tipado eliminado.');
      loadTipados();
    } catch (err) {
      console.error(err);
      showError('No se pudo eliminar.');
    }
  }

  function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    return String(text).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
  }

  // inicial
  loadTipados();

  // exponer globals para botones inline
  window.openEdit = openEdit;
  window.confirmDelete = confirmDelete;
});
</script>
</body>
</html>
